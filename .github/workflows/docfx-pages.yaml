name: Deploy DocFX Pages (Versioned)

# Triggers: manual run or called from another workflow.
# No automatic push or tag triggers — every deployment is intentional.
#
# This workflow is a lightweight companion to docfx.yaml.  It uses
# github.ref_name as the destination folder so it works without any caller
# needing to pass an explicit version string.  Use docfx.yaml (called by
# release.yaml) when you need the full release flow: versions.json generation,
# root deployment, and /latest/ alias.  Use this workflow for ad-hoc or
# branch-based doc previews that do not require that extra machinery.
on:
  # Allow maintainers to trigger a docs build and deploy manually from the
  # Actions tab, selecting any branch or tag as the source ref.
  workflow_dispatch:

  # Allow other workflows to invoke this workflow programmatically.
  # No inputs are defined here because the destination directory is derived
  # automatically from github.ref_name of the calling workflow's ref context,
  # keeping invocation simple for callers that just need a versioned deploy.
  workflow_call:

jobs:
  build-and-deploy:
    name: Build & Deploy Documentation
    runs-on: ubuntu-latest

    permissions:
      contents: write # Required to push the built site to the gh-pages branch

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history is needed for accurate DocFX metadata

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      - name: Install DocFX
        run: dotnet tool update docfx --global

      - name: Build DocFX metadata
        # Generates API reference metadata from the compiled assemblies.
        run: docfx metadata
        working-directory: docfx_project

      - name: Build docs
        # Produces the static site under docfx_project/_site.
        run: docfx build
        working-directory: docfx_project

      - name: Verify DocFX output
        # Fail fast if the build did not produce the expected output directory,
        # preventing a silent empty deployment to gh-pages.
        run: |
          if [ ! -d "_site" ]; then
            echo "Error: DocFX output directory '_site' was not created."
            exit 1
          fi
          if [ -z "$(ls -A "_site")" ]; then
            echo "Error: DocFX output directory '_site' is empty."
            exit 1
          fi
          echo "DocFX output verified. Contents of _site:"
          ls -la _site
        working-directory: docfx_project

      - name: Compute destination directory
        # Sanitizes github.ref_name into a safe, single-segment directory name.
        # Steps applied in order:
        #   1. Replace forward slashes with hyphens (prevents nested paths,
        #      e.g. "feature/docs" → "feature-docs").
        #   2. Replace any character outside [A-Za-z0-9._-] with a hyphen.
        #   3. Collapse consecutive hyphens into one.
        #   4. Strip leading dots and hyphens (avoids hidden/awkward names).
        #   5. Fall back to "latest" if the result is empty, ".", or "..".
        id: dest
        run: |
          RAW="${{ github.ref_name }}"
          SANITIZED="${RAW//\//-}"
          SANITIZED="$(printf '%s' "$SANITIZED" | sed 's/[^A-Za-z0-9._-]/-/g')"
          SANITIZED="$(printf '%s' "$SANITIZED" | sed 's/-\{2,\}/-/g')"
          SANITIZED="$(printf '%s' "$SANITIZED" | sed 's/^[.-]\+//')"
          if [ -z "$SANITIZED" ] || [ "$SANITIZED" = "." ] || [ "$SANITIZED" = ".." ]; then
            SANITIZED="latest"
          fi
          echo "dir=$SANITIZED" >> "$GITHUB_OUTPUT"

      - name: Deploy to GitHub Pages
        # Publishes the built site into a subfolder named after the triggering
        # branch or tag (github.ref_name), e.g. /v1.2.3/ for a v1.2.3 release.
        # keep_files: true preserves all previously deployed version folders so
        # that older docs remain accessible and the DocFX version switcher works.
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docfx_project/_site
          destination_dir: ${{ steps.dest.outputs.dir }}
          keep_files: true
